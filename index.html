<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Real-Time AIS Map</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <!-- Mapbox GL CSS & JS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.js"></script>
    <!-- Firebase SDK (compat versions) -->
    <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-database-compat.js"></script>
    <style>
      body { margin: 0; padding: 0; }
      #map { position: absolute; top: 0; bottom: 0; width: 100%; }
      
      /* Popup Styling */
      .mapboxgl-popup-close-button {
        display: none;
      }
      .mapboxgl-popup-content {
        font: 400 13px/20px 'Source Sans Pro', 'Helvetica Neue', sans-serif;
        padding: 0;
        width: 180px;
      }
      .mapboxgl-popup-content h3 {
        margin: 0;
        padding: 10px;
        border-radius: 3px 3px 0 0;
        font-weight: 700;
        margin-top: -15px;
      }
      /* The header now shows ship name with the country in a smaller font */
      .popup-header-country {
        display: block;
        font-size: 11px;
        opacity: 0.9;
      }
      .mapboxgl-popup-content div {
        padding: 10px;
      }
      .mapboxgl-popup-anchor-top > .mapboxgl-popup-content {
        margin-top: 15px;
      }
      .mapboxgl-popup-anchor-top > .mapboxgl-popup-tip {
        border-bottom-color: inherit;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      // Initialize Mapbox
      mapboxgl.accessToken =
        "pk.eyJ1IjoidmVnYXJkMTk5MCIsImEiOiJjamtsYXdjZm4wMWljM3ZxcmUyOHJoNnBwIn0.sCjF-dZIu4TN21N0GhmFdg";
      const map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/vegard1990/cm7dsvz6s00bk01r4aj1sgo63",
        center: [20.302734, 73.578167],
        zoom: 2,
        projection: "mercator",
        dragRotate: false // disables rotation via mouse drag
      });
      map.setRenderWorldCopies(true);
      map.touchZoomRotate.disableRotation();

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBowluEJyNTZhnx-qlykdHO0JgLZy7d9K8",
        authDomain: "svalbardships-517ab.firebaseapp.com",
        databaseURL: "https://svalbardships-517ab-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "svalbardships-517ab",
        storageBucket: "svalbardships-517ab.firebasestorage.app",
        messagingSenderId: "744978558688",
        appId: "1:744978558688:web:987a97fd1981ee4423ea85"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // Create a popup instance for hover events (no close button)
      const hoverPopup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false
      });

      // Define country-dependent icon expressions.
      const euCountries = ["Austria","Belgium","Bulgaria","Croatia","Cyprus",
                           "Czech Republic","Denmark","Estonia","Finland","France",
                           "Germany","Greece","Hungary","Ireland","Italy","Latvia",
                           "Lithuania","Luxembourg","Malta","Netherlands","Poland",
                           "Portugal","Romania","Slovakia","Slovenia","Spain","Sweden"];

      const circleIconExpression = [
        "case",
          ["==", ["get", "country"], "Norway"], "Norwaycircle",
          ["==", ["get", "country"], "Russian Federation"], "Russiacircle",
          ["==", ["get", "country"], "China (People's Republic of)"], "Chinacircle",
          ["in", ["get", "country"], ["literal", euCountries]], "EUcircle",
          "Unknowncircle"
      ];

      const triangleIconExpression = [
        "case",
          ["==", ["get", "country"], "Norway"], "Norwaytriangle",
          ["==", ["get", "country"], "Russian Federation"], "Russiatriangle",
          ["==", ["get", "country"], "China (People's Republic of)"], "Chinatriangle",
          ["in", ["get", "country"], ["literal", euCountries]], "EUtriangle",
          "Unknowntriangle"
      ];

      // Helper function to convert navigational status to description.
      function getNavStatusDescription(status) {
        switch (Number(status)) {
          case 0: return "Under way using engine";
          case 1: return "At anchor";
          case 2: return "Not under command";
          case 3: return "Restricted manoeuverability";
          case 4: return "Constrained by her draught";
          case 5: return "Moored";
          case 6: return "Aground";
          case 7: return "Engaged in Fishing";
          case 8: return "Under way sailing";
          case 9: return "Reserved for future amendment of Navigational Status for HSC";
          case 10: return "Reserved for future amendment of Navigational Status for WIG";
          case 11: return "Reserved for future use";
          case 12: return "Reserved for future use";
          case 13: return "Reserved for future use";
          case 14: return "AIS-SART is active";
          case 15: return "Not defined (default)";
          default: return "Unknown";
        }
      }

      // ----------------------------
      // Client-Side Map Interaction Code
      // ----------------------------
      
      // Disable hover popups on mobile (width <=600)
      if (window.innerWidth > 600) {
        map.on("mouseenter", "vessels-circle", (e) => {
          map.getCanvas().style.cursor = "pointer";
          const feature = map.queryRenderedFeatures(e.point, {
            layers: ["vessels-circle"]
          })[0];
          if (!feature) return;
          const localTime = new Date(feature.properties.msgtime).toLocaleString();
          const course = (feature.properties.courseOverGround !== null && feature.properties.courseOverGround !== undefined)
                          ? feature.properties.courseOverGround : "N/A";
          const speed = (feature.properties.speedOverGround !== null && feature.properties.speedOverGround !== undefined)
                          ? feature.properties.speedOverGround : "N/A";
          // Use the country from the feature or "Unknown"
          const country = feature.properties.country || "Unknown";
          // Here the hover popup uses simple styling (you could add your colored header if desired)
          const popupContent = `
            <div class="mapboxgl-popup-content">
              <h3 style="background: ${getHeaderColor(country)}; color: ${getHeaderTextColor(country)};">
                ${feature.properties.shipName || "Unnamed Ship"}
                <span class="popup-header-country">${country}</span>
              </h3>
              <div>
                <strong>MMSI:</strong> ${feature.properties.mmsi}<br>
                <strong>Time:</strong> ${localTime}<br>
                <strong>Course:</strong> ${course}<br>
                <strong>Speed:</strong> ${speed}
              </div>
            </div>
          `;
          hoverPopup.setLngLat(feature.geometry.coordinates)
            .setHTML(popupContent)
            .addTo(map);
        });
        map.on("mouseleave", "vessels-circle", () => {
          map.getCanvas().style.cursor = "";
          hoverPopup.remove();
        });
      }

      // -----------------------------
      // FUNCTIONS USED ON THE CLIENT
      // -----------------------------
      
      // Function to fetch and display vessel track (last 24 hours)
      async function showVesselTrack(mmsi) {
        // Remove any existing track layer.
        if (map.getLayer('vessel-track-line')) {
          map.removeLayer('vessel-track-line');
          map.removeSource('vessel-track');
        }
        try {
          const historicToken = await getHistoricAccessToken();
          const response = await fetch(`https://historic.ais.barentswatch.no/v1/historic/trackslast24hours/${mmsi}`, {
            headers: { "Authorization": `Bearer ${historicToken}` }
          });
          const data = await response.json();
          data.sort((a, b) => new Date(a.msgtime) - new Date(b.msgtime));
          const coords = data.map(point => [point.longitude, point.latitude]);
          const geojsonTrack = {
            type: "Feature",
            geometry: {
              type: "LineString",
              coordinates: coords
            }
          };
          map.addSource("vessel-track", { type: "geojson", data: geojsonTrack });
          map.addLayer({
            id: "vessel-track-line",
            type: "line",
            source: "vessel-track",
            layout: { "line-join": "round", "line-cap": "round" },
            paint: {
              "line-color": "#ff4040",
              "line-width": 3,
              "line-opacity": 0.7
            }
          });
        } catch (error) {
          console.error("Error fetching vessel track:", error);
        }
      }

      // -----------------------------
      // Helper Functions for Styling
      // -----------------------------
      function getHeaderColor(country) {
        if (country === "Norway") return "#ff4040";
        if (country === "Russian Federation") return "#7dacff";
        if (euCountries.indexOf(country) !== -1) return "#2b2bcc";
        if (country === "China (People's Republic of)") return "#f2c403";
        return "#f7f7f7"; // Unknown
      }
      function getHeaderTextColor(country) {
        if (getHeaderColor(country).toLowerCase() === "#f7f7f7") return "#333";
        return "#fff";
      }

      // -----------------------------
      // Merged Ship Type Categories
      // -----------------------------
      function getShipTypeDescription(shipType) {
        if (shipType === null || shipType === undefined) return "N/A";
        if (shipType >= 1 && shipType <= 19) return "Reserved for future use";
        if (shipType >= 20 && shipType <= 29) return "Wing in ground";
        if (shipType === 30) return "Fishing";
        if (shipType >= 31 && shipType <= 32) return "Towing";
        if (shipType === 33) return "Dredging/Underwater Ops";
        if (shipType === 34) return "Diving Ops";
        if (shipType === 35) return "Military Ops";
        if (shipType >= 36 && shipType <= 39) return "Sailing";
        if (shipType >= 40 && shipType <= 49) return "High Speed Craft";
        if (shipType >= 50 && shipType <= 59) {
          if (shipType === 50) return "Pilot Vessel";
          if (shipType === 51) return "Search & Rescue";
          if (shipType === 52) return "Tug";
          if (shipType === 53) return "Port Tender";
          if (shipType === 54) return "Anti-pollution";
          if (shipType === 55) return "Law Enforcement";
          return "Local Vessel";
        }
        if (shipType >= 60 && shipType <= 69) return "Passenger";
        if (shipType >= 70 && shipType <= 79) return "Cargo";
        if (shipType >= 80 && shipType <= 89) return "Tanker";
        if (shipType >= 90 && shipType <= 99) return "Other Type";
        return "Unknown";
      }

      // -----------------------------
      // Map Layers and Popup Events
      // -----------------------------
      map.on("load", () => {
        // Create an empty GeoJSON source for vessels.
        map.addSource("vessels", {
          type: "geojson",
          data: { type: "FeatureCollection", features: [] }
        });

        // Layer for vessel markers using circle icons.
        map.addLayer({
          id: "vessels-circle",
          type: "symbol",
          source: "vessels",
          layout: {
            "icon-image": circleIconExpression,
            "icon-allow-overlap": true,
            "icon-ignore-placement": true,
            "icon-size": [
              "interpolate",
              ["linear"],
              ["zoom"],
              5, 0.3,
              7, 0.8
            ]
          },
          paint: {
            "icon-opacity": [
              "interpolate",
              ["linear"],
              ["zoom"],
              5, 1,
              5.5, 0
            ]
          }
        });

        // Layer for vessel markers using triangle icons.
        map.addLayer({
          id: "vessels-triangle",
          type: "symbol",
          source: "vessels",
          layout: {
            "icon-image": triangleIconExpression,
            "icon-allow-overlap": true,
            "icon-ignore-placement": true,
            "icon-rotate": ["get", "trueHeading"],
            "icon-size": [
              "interpolate",
              ["linear"],
              ["zoom"],
              5, 0.5,
              7, 0.8
            ]
          },
          paint: {
            "icon-opacity": [
              "interpolate",
              ["linear"],
              ["zoom"],
              5, 0,
              5.5, 1
            ]
          }
        });

        // Invisible hit layer for easier click events.
        map.addLayer({
          id: "vessels-hit",
          type: "circle",
          source: "vessels",
          paint: {
            "circle-radius": 20,
            "circle-color": "#000000",
            "circle-opacity": 0
          }
        });

        // Layer for vessel names (labels).
        map.addLayer({
          id: "vessels-label",
          type: "symbol",
          source: "vessels",
          minzoom: 5,
          layout: {
            "text-field": ["get", "shipName"],
            "text-transform": "uppercase",
            "text-offset": [0, 1.2],
            "text-size": 10,
            "text-font": ["DIN Pro Bold", "Arial Unicode MS Regular"]
          },
          paint: {
            "text-color": "#ffffff"
          }
        });

        // Hover event: Only enable on wider screens.
        if (window.innerWidth > 600) {
          map.on("mouseenter", "vessels-circle", (e) => {
            map.getCanvas().style.cursor = "pointer";
            const feature = map.queryRenderedFeatures(e.point, { layers: ["vessels-circle"] })[0];
            if (!feature) return;
            const localTime = new Date(feature.properties.msgtime).toLocaleString();
            const course = (feature.properties.courseOverGround !== null && feature.properties.courseOverGround !== undefined)
                            ? feature.properties.courseOverGround : "N/A";
            const speed = (feature.properties.speedOverGround !== null && feature.properties.speedOverGround !== undefined)
                            ? feature.properties.speedOverGround : "N/A";
            const country = feature.properties.country || "Unknown";
            const headerBg = getHeaderColor(country);
            const headerTextColor = getHeaderTextColor(country);
            const popupContent = `
              <div class="mapboxgl-popup-content">
                <h3 style="background: ${headerBg}; color: ${headerTextColor};">
                  ${feature.properties.shipName || "Unnamed Ship"}
                  <span class="popup-header-country">${country}</span>
                </h3>
                <div>
                  <strong>MMSI:</strong> ${feature.properties.mmsi}<br>
                  <strong>Time:</strong> ${localTime}<br>
                  <strong>Course:</strong> ${course}<br>
                  <strong>Speed:</strong> ${speed}
                </div>
              </div>
            `;
            hoverPopup.setLngLat(feature.geometry.coordinates)
              .setHTML(popupContent)
              .addTo(map);
          });
          map.on("mouseleave", "vessels-circle", () => {
            map.getCanvas().style.cursor = "";
            hoverPopup.remove();
          });
        }

        // Click event: Show detailed popup with "Show Track" link.
        map.on("click", "vessels-hit", (e) => {
          const feature = e.features[0];
          if (!feature) return;
          const localTime = new Date(feature.properties.msgtime).toLocaleString();
          const course = (feature.properties.courseOverGround !== null && feature.properties.courseOverGround !== undefined)
                          ? feature.properties.courseOverGround : "N/A";
          const speed = (feature.properties.speedOverGround !== null && feature.properties.speedOverGround !== undefined)
                          ? feature.properties.speedOverGround : "N/A";
          const trueHeading = (feature.properties.trueHeading !== null && feature.properties.trueHeading !== undefined)
                          ? feature.properties.trueHeading : "N/A";
          const navStatus = getNavStatusDescription(feature.properties.navigationalStatus);
          const country = feature.properties.country || "Unknown";
          const headerBg = getHeaderColor(country);
          const headerTextColor = getHeaderTextColor(country);
          const detailedPopupContent = `
            <div class="mapboxgl-popup-content">
              <h3 style="background: ${headerBg}; color: ${headerTextColor};">
                ${feature.properties.shipName || "Unnamed Ship"}
                <span class="popup-header-country">${country}</span>
              </h3>
              <div>
                <strong>MMSI:</strong> ${feature.properties.mmsi}<br>
                <strong>Time:</strong> ${localTime}<br>
                <strong>Course:</strong> ${course}<br>
                <strong>Speed:</strong> ${speed}<br>
                <strong>Navigational Status:</strong> ${navStatus}<br>
                <strong>Destination:</strong> ${feature.properties.destination || "N/A"}<br>
                <strong>ETA:</strong> ${feature.properties.eta || "N/A"}<br>
                <strong>Ship Type:</strong> ${feature.properties.shipTypeDesc || "N/A"}<br>
                <strong>True Heading:</strong> ${trueHeading}
              </div>
              <div class="show-track-link" onclick="showVesselTrack(${feature.properties.mmsi})">
                Show Track
              </div>
            </div>
          `;
          new mapboxgl.Popup()
            .setLngLat(feature.geometry.coordinates)
            .setHTML(detailedPopupContent)
            .addTo(map);
        });

        // Listen for realtime updates from Firebase.
        db.ref("vessels").on("value", (snapshot) => {
          const data = snapshot.val();
          const features = [];
          for (const mmsi in data) {
            const vessel = data[mmsi];
            features.push({
              type: "Feature",
              geometry: {
                type: "Point",
                coordinates: [vessel.longitude, vessel.latitude]
              },
              properties: {
                shipName: vessel.shipName,
                mmsi: vessel.mmsi,
                msgtime: vessel.msgtime,
                courseOverGround: vessel.courseOverGround,
                navigationalStatus: vessel.navigationalStatus,
                destination: vessel.destination,
                eta: vessel.eta,
                shipType: vessel.shipType,
                shipTypeDesc: vessel.shipTypeDesc,
                speedOverGround: vessel.speedOverGround,
                trueHeading: vessel.trueHeading,
                country: vessel.country
              }
            });
          }
          const geojson = { type: "FeatureCollection", features: features };
          map.getSource("vessels").setData(geojson);
        });
      });
    </script>
  </body>
</html>
